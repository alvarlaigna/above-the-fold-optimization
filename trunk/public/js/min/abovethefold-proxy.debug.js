!function(e){var r,o,t=!1,l=!1,n=!1,f=!1,c=!1,a=!1,i=!1,s=!1,u=[],p=[],d=[],h={},b=[];e.ps=function(e){if(void 0===g)var g=!1;if((r=e.url||g)||console.error("Abtf.proxy()","no proxy url",e),t=e.js||!1,l=e.css||!1,(n=e.cdn||!1)&&b.push(n),f=e.js_include||!1,c=e.js_exclude||!1,a=e.css_include||!1,i=e.css_exclude||!1,e.preload){s=!0;for(x=0;x<e.preload.length;x++)"regex"===e.preload[x][0]?(d.push([e.preload[x][2],e.preload[x][3],e.preload[x][1]]),e.preload[x][4]&&(h[e.preload[x][0]]=e.preload[x][4],-1===b.indexOf(e.preload[x][4])&&b.push(e.preload[x][4]))):(u.push(e.preload[x][0]),p.push(e.preload[x][1]),e.preload[x][4]&&(h[e.preload[x][0]]=e.preload[x][4],-1===b.indexOf(e.preload[x][4])&&b.push(e.preload[x][4])));o=e.base||!1}if(0===b.length)b=!1;else for(var v=b.length,x=0;x<v;x++)b[x]=A(b[x])};var g={Element:"undefined"!=typeof Element&&Element,Document:"undefined"!=typeof Document&&Document},v={append:{},insert:{}};for(var x in g)g.hasOwnProperty(x)&&g[x]&&(v.append[x]=g[x].prototype.appendChild,v.insert[x]=g[x].prototype.insertBefore);var y=document.createElement("a");y.href=document.location.href;var A=function(e){var r=document.createElement("a");return r.href=e,r},U=function(e,o){return"css"===o?r.replace("{PROXY:URL}",escape(e)).replace("{PROXY:TYPE}",escape(o)):"js"===o?r.replace("{PROXY:URL}",escape(e)).replace("{PROXY:TYPE}",escape(o)):void 0},m=function(r,t){var l,n=!1;if(s){var f=u.indexOf(r);if(f>-1)var c=p[f];else if(d.length>0)for(var a,i,b=d.length,g=0;g<b;g++){i=!1;try{a=new RegExp(d[g][0],d[g][1]||"")}catch(e){i=!0}if(!i&&a.test(r)){n=!0,l=r,d[g][2]?c=d[g][2]:d[g][3]&&(r=d[g][3]);break}}if(c){if(void 0!==h[r])v=h[r];else var v=o;v+=c.substr(0,2)+"/",v+=c.substr(2,2)+"/",v+=c.substr(4,2)+"/",v+=c;var x=!1;if("js"===t){if(v+=".js",void 0!==e.csu){var y=A(v).href;(v=e.csu(y))!==y&&(x=v)}}else"css"===t&&(v+=".css");return x?n?console.log("Abtf.proxy()","localStorage regex capture",e.localUrl(l),"➤","cache:"+c,"➤",x):console.log("Abtf.proxy()","localStorage capture",e.localUrl(r),"➤","cache:"+c,"➤",x):n?console.log("Abtf.proxy()","regex capture",e.localUrl(l),"➤","cache:"+c):console.log("Abtf.proxy()","capture",e.localUrl(r),"➤","cache:"+c),v}}if("js"===t&&void 0!==e.csu){var m=A(r).href;if((r=e.csu(m))!==m)return n?console.log("Abtf.proxy()","localStorage regex capture",e.localUrl(l),"regex","➤",e.localUrl(m),"➤",r):console.log("Abtf.proxy()","localStorage capture",e.localUrl(m),"➤",r),r}return n?console.log("Abtf.proxy()","capture",e.localUrl(l),"regex","➤",r):console.log("Abtf.proxy()","capture",e.localUrl(r)),U(r,t)},O=function(e,r){var o="object"==typeof e&&void 0!==e.href?e:A(e);if("blob:"===o.protocol)return!1;if(b&&!0!==r)for(var t=b.length,l=0;l<t;l++)if(-1!==o.href.indexOf(b[l].href))return!1;return o.host!==y.host},j=function(r){var o="object"==typeof r&&void 0!==r.href?r:A(r);if("blob:"===o.protocol)return!0;if(f){for(var t=!1,l=f.length,n=0;n<l;n++)if(-1!==o.href.indexOf(f[n])){t=!0;break}if(!t)return console.log("Abtf.proxy()","ignore",e.localUrl(o.href),"not on include list"),!0}if(c)for(var l=c.length,n=0;n<l;n++)if(-1!==o.href.indexOf(c[n]))return console.log("Abtf.proxy()","ignore",e.localUrl(o.href),"on exclude list:",c[n]),!0;return!1},P=function(e){var r="object"==typeof e&&void 0!==e.href?e:A(e);if("blob:"===r.protocol)return!1;if(b)for(var o=b.length,t=0;t<o;t++)if(-1!==r.href.indexOf(b[t].href))return!1;return r.host!==y.host},C=function(r){var o="object"==typeof r&&void 0!==r.href?r:A(r);if("blob:"===o.protocol)return!0;if(a){for(var t=!1,l=a.length,n=0;n<l;n++)if(-1!==o.href.indexOf(a[n])){t=!0;break}if(!t)return console.log("Abtf.proxy()","ignore",e.localUrl(o.href),"not on include list"),!0}if(i)for(var l=i.length,n=0;n<l;n++)if(-1!==o.href.indexOf(i[n]))return console.log("Abtf.proxy()","ignore",e.localUrl(o.href),"on exclude list:",i[n]),!0;return!1},E=function(r){if(r.nodeName)if("SCRIPT"===r.nodeName.toUpperCase()){if(!t)return!1;if("abtf"===r.getAttribute("rel"))return r.removeAttribute("rel"),!1;if(r.src){o=A(r.src);if(j(o))return!1;if(!O(o)){if(void 0!==e.csu){if("blob:"===o.protocol)return!1;url=e.csu(o.href),url!==o.href?(console.log("Abtf.proxy()","localStorage local capture",e.localUrl(o.href),"➤",url),r.src=url):console.log("Abtf.proxy()","localStorage local capture",e.localUrl(o.href),"➤","bypass cache","➤",url)}return!1}return"js"}}else if("LINK"===r.nodeName.toUpperCase()&&"stylesheet"===r.rel.toLowerCase()){if(!l)return!1;if("abtf"===r.getAttribute("rel"))return r.removeAttribute("rel"),!1;if(r.href){var o=A(r.href);return!C(o)&&(!!P(o)&&"css")}}return!1},R=function(e){var r=E(e);if(!r)return!1;var o=A("css"===r?e.href:e.src).href,t=m(o,r);"css"===r?e.href=t:"js"===r&&(e.src=t)},S={appendChild:function(e,r){return R(r),v.append[e].call(this,r)},insertBefore:function(e,r,o){return R(r),v.insert[e].call(this,r,o)}};for(var x in g)g.hasOwnProperty(x)&&g[x]&&function(e){g[e].prototype.appendChild=function(r){return S.appendChild.call(this,e,r)},g[e].prototype.insertBefore=function(r,o){return S.insertBefore.call(this,e,r,o)}}(x);e.pxs=function(e){return O(e,!0)?U(e,"js"):e}}(window.Abtf);